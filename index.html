<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marginal effects for a wide variety of models • marginaleffects</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Marginal effects for a wide variety of models">
<meta property="og:description" content='Compute, summarize, and plot "marginal effects" for a wide variety of models. The package uses automatic differentiation to compute marginal effects for numeric regressors (partial derivatives of the regression equation), and calculates adjusted contrasts for categorical regressors.'>
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">marginaleffects</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Functions</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/terminology.html">Terminology</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/vincentarelbundock/marginaleffects/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="the-marginaleffects-package-for-r" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#the-marginaleffects-package-for-r" class="anchor"></a>The <code>marginaleffects</code> package for <code>R</code>
</h1></div>
<!-- badges: start -->

<p>This package is still experimental. <em>Use with caution!</em></p>
<div id="what" class="section level2">
<h2 class="hasAnchor">
<a href="#what" class="anchor"></a>What?</h2>
<p>The <code>marginaleffects</code> package allows <code>R</code> users to compute and plot marginal effects for a <em>wide</em> variety of models.</p>
<p>A “marginal effect” is a measure of the association between a change in a regressor, and a change in the response variable. More formally, <a href="https://cran.r-project.org/web/packages/margins/index.html">the excellent <code>margins</code> vignette</a> defines the concept as follows:</p>
<blockquote>
<p>Marginal effects are partial derivatives of the regression equation with respect to each variable in the model for each unit in the data.</p>
</blockquote>
<p>Marginal effects are extremely useful, because they are intuitive and easy to interpret. They are often the main quantity of interest in an empirical analysis.</p>
</div>
<div id="why" class="section level2">
<h2 class="hasAnchor">
<a href="#why" class="anchor"></a>Why?</h2>
<p>To calculate marginal effects we need to take derivatives of the regression equation. This can be challenging to do manually, especially when our models are non-linear, or when regressors are transformed or interacted. Computing the variance of a marginal effect is even more difficult.</p>
<p>The <code>marginaleffects</code> package hopes to do most of this hard work for you.</p>
<p>Many <code>R</code> packages advertise their ability to compute “marginal effects.” However, most of them do <em>not</em> actually compute marginal effects <em>as defined above</em> (the term is ambiguously defined in the statistical literature and used differently across fields). Instead, they compute related quantities such as “Estimated Marginal Means” or “Differences in Predicted Probabilities.” The rare packages that actually compute marginal effects are typically limited in the model types they support, and in the range of transformations they allow (interactions, polynomials, etc.).</p>
<p>The main package in the <code>R</code> ecosystem to compute marginal effects is <a href="https://cran.r-project.org/web/packages/margins/index.html">the fantastic, trailblazing, and powerful <code>margins</code></a> by <a href="https://thomasleeper.com/">Thomas J. Leeper.</a> The <code>marginaleffects</code> package is (essentially) a clone of <code>margins</code>.</p>
<p>So why did I write a clone?</p>
<ul>
<li>
<em>Speed:</em> In one benchmark (see below), computing unit-level standard errors is over 400x faster with <code>marginaleffects</code> (1 minute vs. 150 milliseconds).</li>
<li>
<em>Efficiency:</em> Smaller memory footprint (1.8GB vs 52MB in the same example).</li>
<li>
<em>Extensibility:</em> Adding support for new models is very easy, often requiring less than 10 lines of new code. In the medium run, the goal is to add support for <em>several</em> more model types.</li>
<li>
<code>ggplot2</code> support for plotting (conditional) marginal effects.</li>
<li>
<em>Tidy:</em> The results produced by <code>marginaleffects</code> follow “tidy” principles. They are easy to process and program with.</li>
<li>
<em>User interface:</em> Slight changes to the user interface are intended to improve the experience.</li>
<li><em>Active development</em></li>
</ul>
<p>Downsides of <code>marginaleffects</code> include:</p>
<ul>
<li>Weights and simultation-based inference are not (yet) supported.</li>
<li>More dependencies.</li>
<li>Newer package with a smaller (read: nonexistent) user base.</li>
</ul>
</div>
<div id="how" class="section level2">
<h2 class="hasAnchor">
<a href="#how" class="anchor"></a>How?</h2>
<p>By using <a href="https://cran.r-project.org/web/packages/numDeriv/index.html">the <code>numDeriv</code> package</a> to compute gradients and jacobians. That’s it. That’s the secret sauce.</p>
</div>
<div id="supported-models" class="section level2">
<h2 class="hasAnchor">
<a href="#supported-models" class="anchor"></a>Supported models</h2>
<p>This table shows the list of models supported by <code>marginaleffect</code>, and shows which numerical results have been checked against alternative software packages: Stata’s <code>margins</code> command and R’s <code>margins</code> package.</p>
<p>I am <em>very</em> eager to add support for new models. Feel free to file a request on Github or – even better – submit some code.</p>
<p>Warning: When using <code>marginaleffects</code> with different models, you will probably have to adjust the <code>prediction_type</code> argument. Refer to the documentation of your modeling package to see what <code>type</code> argument is allowed in the <code>predict</code> function.</p>
<table class="table">
<thead><tr class="header">
<th align="left">Model</th>
<th align="left">Support: Effect</th>
<th align="left">Support: Std. Errors</th>
<th align="left">Validity: Stata</th>
<th align="left">Validity: Margins</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">stats::lm</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left">x</td>
</tr>
<tr class="even">
<td align="left">stats::glm</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left">x</td>
</tr>
<tr class="odd">
<td align="left">aer::ivreg</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left">x</td>
</tr>
<tr class="even">
<td align="left">aer::tobit</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">betareg::betareg</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left">x</td>
</tr>
<tr class="even">
<td align="left">bife::bife</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">estimatr::lm_robust</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">fixest::feols</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">fixest::feglm</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">gam::gam</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">geepack::geeglm</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">ivreg::ivreg</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left">x</td>
</tr>
<tr class="odd">
<td align="left">lme4::lmer</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left">dydx only</td>
</tr>
<tr class="even">
<td align="left">lme4::glmer</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left">dydx only</td>
</tr>
<tr class="odd">
<td align="left">MASS::glm.nb</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left">x</td>
</tr>
<tr class="even">
<td align="left">MASS::polr</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left">x</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">MASS::rlm</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">nlme::gls</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">ordinal::clm</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
<td align="left">x</td>
</tr>
<tr class="even">
<td align="left">plm::plm</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">pscl::hurdle</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">rms::lrm</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">speedglm::speedglm</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">speedglm::speedlm</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">survey::svyglm</td>
<td align="left">x</td>
<td align="left">x</td>
<td align="left"></td>
<td align="left">x</td>
</tr>
</tbody>
</table>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>You can install the latest version of <code>marginaleffects</code> from Github:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"vincentarelbundock/marginaleffects"</span><span class="op">)</span></code></pre></div>
</div>
<div id="getting-started" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-started" class="anchor"></a>Getting started</h2>
<p>First, we load the library, download the <a href="https://allisonhorst.github.io/palmerpenguins/">Palmer Penguins</a> data from the <a href="https://vincentarelbundock.github.io/Rdatasets/articles/data.html"><code>Rdatasets</code> archive</a>, and estimate a GLM model:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span>

<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"https://vincentarelbundock.github.io/Rdatasets/csv/palmerpenguins/penguins.csv"</span><span class="op">)</span>
<span class="va">dat</span><span class="op">$</span><span class="va">large_penguin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">body_mass_g</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">body_mass_g</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>

<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">large_penguin</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">flipper_length_mm</span> <span class="op">+</span> <span class="va">species</span>, 
           data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></code></pre></div>
<p>A “marginal effect” is a unit-specific measure of association between a change in a regressor and a change in the regressand. In most cases, its value will depend on the values of all the other variables in the model for that specific unit.</p>
<p>The <code>marginaleffects</code> function thus computes a distinct estimate of the marginal effect and of the standard error for each regressor (“term”), for each unit of observation (“rowid”). You can view and manipulate the full results with functions like <code>head</code>, as you would with any other <code>data.frame</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mfx</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span>
<span class="co">#&gt;   rowid     type              term        dydx   std.error predicted_response</span>
<span class="co">#&gt; 1     1 response    bill_length_mm 0.017622745 0.007837288         0.05123266</span>
<span class="co">#&gt; 2     1 response flipper_length_mm 0.006763748 0.001561740         0.05123266</span>
<span class="co">#&gt; 3     2 response    bill_length_mm 0.035846649 0.011917159         0.11125087</span>
<span class="co">#&gt; 4     2 response flipper_length_mm 0.013758244 0.002880123         0.11125087</span>
<span class="co">#&gt; 5     3 response    bill_length_mm 0.084433436 0.021119186         0.36919834</span>
<span class="co">#&gt; 6     3 response flipper_length_mm 0.032406447 0.008159318         0.36919834</span>
<span class="co">#&gt;   large_penguin bill_length_mm flipper_length_mm species</span>
<span class="co">#&gt; 1             0           39.1               181  Adelie</span>
<span class="co">#&gt; 2             0           39.1               181  Adelie</span>
<span class="co">#&gt; 3             0           39.5               186  Adelie</span>
<span class="co">#&gt; 4             0           39.5               186  Adelie</span>
<span class="co">#&gt; 5             0           40.3               195  Adelie</span>
<span class="co">#&gt; 6             0           40.3               195  Adelie</span></code></pre></div>
<p>Notice that the results are presented in “tidy” long format: each row of the original dataset gets a unique <code>rowid</code> value, each unit-level marginal effect appears on a distinct row, and metadata appears neatly in separate columns. This makes it easy to operate on the results programmatically.</p>
</div>
<div id="average-marginal-effects" class="section level2">
<h2 class="hasAnchor">
<a href="#average-marginal-effects" class="anchor"></a>Average Marginal Effects</h2>
<p>A dataset with one marginal effect estimate per unit of observation is a bit unwieldy and difficult to interpret. Many analysts like to report the “Average Marginal Effect”, that is, the average of all the observation-specific marginal effects. These are easy to compute based on the full <code>data.frame</code> shown above, but the <code>summary</code> function is convenient:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span>
<span class="co">#&gt; Average marginal effects </span>
<span class="co">#&gt;       type              Term           Contrast   Effect Std. Error   z value</span>
<span class="co">#&gt; 1 response    bill_length_mm                     0.02757    0.00849   3.24819</span>
<span class="co">#&gt; 2 response flipper_length_mm                     0.01058    0.00332   3.18766</span>
<span class="co">#&gt; 3 response           species Chinstrap - Adelie -0.80570    0.07713 -10.44590</span>
<span class="co">#&gt; 4 response           species    Gentoo - Adelie  0.08359    0.11563   0.72294</span>
<span class="co">#&gt; 5 response           species Gentoo - Chinstrap  0.88929    0.08534  10.42061</span>
<span class="co">#&gt;     Pr(&gt;|z|)    2.5 %   97.5 %</span>
<span class="co">#&gt; 1  0.0011614  0.01093  0.04421</span>
<span class="co">#&gt; 2  0.0014343  0.00408  0.01709</span>
<span class="co">#&gt; 3 2.9754e-14 -0.95687 -0.65453</span>
<span class="co">#&gt; 4  0.7498870 -0.14304  0.31023</span>
<span class="co">#&gt; 5 3.1086e-14  0.72203  1.05656</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model type:  glm </span>
<span class="co">#&gt; Prediction type:  response</span></code></pre></div>
<p>Note that since marginal effects are derivatives, they are only properly defined for continuous numeric variables. When the model also includes categorical regressors, the <code>summary</code> function will try to display relevant (regression-adjusted) contrasts between different categories, as shown above. This optional feature requires users to install the <code>emmeans</code> package.</p>
<p>You can also extract average marginal effects using <code>tidy</code> and <code>glance</code> methods which conform to the <a href="https://broom.tidymodels.org/"><code>broom</code> package specification</a>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 5 × 9</span>
<span class="co">#&gt; # Groups:   type [1]</span>
<span class="co">#&gt;   type     term  contrast estimate std.error statistic  p.value conf.low conf.high</span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 response bill… &lt;NA&gt;       0.0276   0.00849     3.25  1.16e- 3  0.0109     0.0442</span>
<span class="co">#&gt; 2 response flip… &lt;NA&gt;       0.0106   0.00332     3.19  1.43e- 3  0.00408    0.0171</span>
<span class="co">#&gt; 3 response spec… Chinstr…  -0.806    0.0771    -10.4   2.98e-14 -0.957     -0.655 </span>
<span class="co">#&gt; 4 response spec… Gentoo …   0.0836   0.116       0.723 7.50e- 1 -0.143      0.310 </span>
<span class="co">#&gt; 5 response spec… Gentoo …   0.889    0.0853     10.4   3.11e-14  0.722      1.06</span>

<span class="fu"><a href="https://generics.r-lib.org/reference/glance.html">glance</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span>
<span class="co">#&gt;   null.deviance df.null    logLik      AIC      BIC deviance df.residual nobs</span>
<span class="co">#&gt; 1      473.8202     341 -84.92257 179.8451 199.0192 169.8451         337  342</span></code></pre></div>
</div>
<div id="typical-marginal-effects" class="section level2">
<h2 class="hasAnchor">
<a href="#typical-marginal-effects" class="anchor"></a>Typical Marginal Effects</h2>
<p>Sometimes, we are not interested in <em>all</em> the unit-specific marginal effects, but would rather look at the estimated marginal effects for certain “typical” individuals. The <code>typical</code> function helps us build datasets full of “typical” rows. For example, to generate artificial Adelies and Gentoos with 180mm flippers:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/typical.html">typical</a></span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fl">180</span>, 
        species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Adelie"</span>, <span class="st">"Gentoo"</span><span class="op">)</span>, 
        model <span class="op">=</span> <span class="va">mod</span><span class="op">)</span>
<span class="co">#&gt;   bill_length_mm flipper_length_mm species</span>
<span class="co">#&gt; 1       43.92193               180  Adelie</span>
<span class="co">#&gt; 2       43.92193               180  Gentoo</span></code></pre></div>
<p>The same command can be used (omitting the <code>model</code> argument) to <code>marginaleffects</code>’s <code>newdata</code> argument to compute marginal effects for those (fictional) individuals:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="fu"><a href="reference/typical.html">typical</a></span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fl">180</span>, 
                                       species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Adelie"</span>, <span class="st">"Gentoo"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;   rowid     type              term       dydx   std.error predicted_response</span>
<span class="co">#&gt; 1     1 response    bill_length_mm 0.06067504 0.033257106          0.2125242</span>
<span class="co">#&gt; 2     1 response flipper_length_mm 0.02328764 0.005498309          0.2125242</span>
<span class="co">#&gt; 3     2 response    bill_length_mm 0.08466334 0.040417468          0.3716454</span>
<span class="co">#&gt; 4     2 response flipper_length_mm 0.03249469 0.008616513          0.3716454</span>
<span class="co">#&gt;   bill_length_mm flipper_length_mm species</span>
<span class="co">#&gt; 1       43.92193               180  Adelie</span>
<span class="co">#&gt; 2       43.92193               180  Adelie</span>
<span class="co">#&gt; 3       43.92193               180  Gentoo</span>
<span class="co">#&gt; 4       43.92193               180  Gentoo</span></code></pre></div>
<p>When variables are omitted from the <code>typical</code> call, they will automatically be set at their median or mode (depending on variable type).</p>
</div>
<div id="counterfactual-marginal-effects" class="section level2">
<h2 class="hasAnchor">
<a href="#counterfactual-marginal-effects" class="anchor"></a>Counterfactual Marginal Effects</h2>
<p>The <code>typical</code> function allowed us look at completely fictional individuals. The <code>counterfactual</code> function lets us compute the marginal effects for the actual observations in our dataset, but with a few manipulated values. For example, this code will create a <code>data.frame</code> twice as long as the original <code>dat</code>, where each observation is repeated with different values of the <code>flipper_length_mm</code> variable:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/counterfactual.html">counterfactual</a></span><span class="op">(</span>flipper_length_mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">160</span>, <span class="fl">180</span><span class="op">)</span>, model <span class="op">=</span> <span class="va">mod</span><span class="op">)</span></code></pre></div>
<p>We see that the rows 1, 2, and 3 of the original dataset have been replicated twice, with different values of the <code>flipper_length_mm</code> variable:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nd</span><span class="op">[</span><span class="va">nd</span><span class="op">$</span><span class="va">rowid</span> <span class="op">%in%</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="op">]</span>
<span class="co">#&gt;     rowid bill_length_mm species flipper_length_mm</span>
<span class="co">#&gt; 1       1           39.1  Adelie               160</span>
<span class="co">#&gt; 2       2           39.5  Adelie               160</span>
<span class="co">#&gt; 3       3           40.3  Adelie               160</span>
<span class="co">#&gt; 343     1           39.1  Adelie               180</span>
<span class="co">#&gt; 344     2           39.5  Adelie               180</span>
<span class="co">#&gt; 345     3           40.3  Adelie               180</span></code></pre></div>
<p>Again, we can use this to compute average (or median) marginal effects over the counterfactual individuals:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="fu"><a href="reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">nd</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">term</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">dydx</span><span class="op">:</span><span class="va">std.error</span>, <span class="va">median</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 × 3</span>
<span class="co">#&gt;   term                 dydx std.error</span>
<span class="co">#&gt;   &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 bill_length_mm    0.00985   0.00628</span>
<span class="co">#&gt; 2 flipper_length_mm 0.00378   0.00144</span></code></pre></div>
</div>
<div id="tables" class="section level2">
<h2 class="hasAnchor">
<a href="#tables" class="anchor"></a>Tables</h2>
<p>Average marginal effects are easy to display in a regression table using packages like <code>modelsummary</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/modelsummary/">modelsummary</a></span><span class="op">)</span>

<span class="co"># fit models and store them in a named list</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="st">"Logit"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">large_penguin</span> <span class="op">~</span> <span class="va">flipper_length_mm</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span>,
    <span class="st">"OLS"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">flipper_length_mm</span> <span class="op">+</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span><span class="op">)</span>

<span class="co"># apply the `marginaleffects` function to all the models using `lapply`</span>
<span class="va">mfx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">mod</span>, <span class="va">marginaleffects</span><span class="op">)</span>

<span class="co"># build a table</span>
<span class="fu"><a href="https://vincentarelbundock.github.io/modelsummary/reference/modelsummary.html">modelsummary</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left"></th>
<th align="center">Logit</th>
<th align="center">OLS</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">flipper_length_mm</td>
<td align="center">0.020</td>
<td align="center">48.145</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center">(0.003)</td>
<td align="center">(2.011)</td>
</tr>
<tr class="odd">
<td align="left">bill_length_mm</td>
<td align="center"></td>
<td align="center">6.047</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="center"></td>
<td align="center">(5.180)</td>
</tr>
<tr class="odd">
<td align="left">Num.Obs.</td>
<td align="center">342</td>
<td align="center">342</td>
</tr>
<tr class="even">
<td align="left">R2</td>
<td align="center"></td>
<td align="center">0.760</td>
</tr>
<tr class="odd">
<td align="left">R2 Adj.</td>
<td align="center"></td>
<td align="center">0.759</td>
</tr>
<tr class="even">
<td align="left">AIC</td>
<td align="center">222.2</td>
<td align="center">5063.5</td>
</tr>
<tr class="odd">
<td align="left">BIC</td>
<td align="center">229.9</td>
<td align="center">5078.8</td>
</tr>
<tr class="even">
<td align="left">Log.Lik.</td>
<td align="center">-109.111</td>
<td align="center">-2527.741</td>
</tr>
<tr class="odd">
<td align="left">F</td>
<td align="center"></td>
<td align="center">536.626</td>
</tr>
</tbody>
</table>
<p>You can also display models with contrasts using <code>modelsummary</code>’s <code>group</code> argument:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">flipper_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">body_mass_g</span> <span class="op">~</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span><span class="op">)</span>

<span class="va">mfx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">mod</span>, <span class="va">marginaleffects</span><span class="op">)</span>

<span class="fu"><a href="https://vincentarelbundock.github.io/modelsummary/reference/modelsummary.html">modelsummary</a></span><span class="op">(</span><span class="va">mfx</span>, group <span class="op">=</span> <span class="va">term</span> <span class="op">+</span> <span class="va">contrast</span> <span class="op">~</span> <span class="va">model</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left"></th>
<th align="left"></th>
<th align="center">Model 1</th>
<th align="center">Model 2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">flipper_length_mm</td>
<td align="left"></td>
<td align="center">40.705</td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="center">(3.068)</td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left">species</td>
<td align="left">Chinstrap - Adelie</td>
<td align="center">-206.510</td>
<td align="center">32.426</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="center">(57.731)</td>
<td align="center">(67.512)</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">Gentoo - Adelie</td>
<td align="center">266.810</td>
<td align="center">1375.354</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="center">(95.264)</td>
<td align="center">(56.148)</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">Gentoo - Chinstrap</td>
<td align="center">473.320</td>
<td align="center">1342.928</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="center">(86.746)</td>
<td align="center">(69.857)</td>
</tr>
<tr class="odd">
<td align="left">Num.Obs.</td>
<td align="left"></td>
<td align="center">342</td>
<td align="center">342</td>
</tr>
<tr class="even">
<td align="left">R2</td>
<td align="left"></td>
<td align="center">0.783</td>
<td align="center">0.670</td>
</tr>
<tr class="odd">
<td align="left">R2 Adj.</td>
<td align="left"></td>
<td align="center">0.781</td>
<td align="center">0.668</td>
</tr>
<tr class="even">
<td align="left">AIC</td>
<td align="left"></td>
<td align="center">5031.5</td>
<td align="center">5172.7</td>
</tr>
<tr class="odd">
<td align="left">BIC</td>
<td align="left"></td>
<td align="center">5050.7</td>
<td align="center">5188.0</td>
</tr>
<tr class="even">
<td align="left">Log.Lik.</td>
<td align="left"></td>
<td align="center">-2510.762</td>
<td align="center">-2582.337</td>
</tr>
<tr class="odd">
<td align="left">F</td>
<td align="left"></td>
<td align="center">405.693</td>
<td align="center">343.626</td>
</tr>
</tbody>
</table>
</div>
<div id="plots-ggplot2" class="section level2">
<h2 class="hasAnchor">
<a href="#plots-ggplot2" class="anchor"></a>Plots (<code>ggplot2</code>)</h2>
<p>Since the output of the <code>marginaleffects</code> function is “tidy”, it is very easy to use the <code>data.frame</code> that this function produces directly to draw plots with any drawing package you like. In addition, the <code>marginaleffects</code> package also offers functions to draw frequently used plots with <code>ggplot2</code>.</p>
<p>The first is a simple <code>plot</code> command to draw the average marginal effects:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">hp</span> <span class="op">+</span> <span class="va">wt</span> <span class="op">+</span> <span class="va">drat</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span>
<span class="va">mfx</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-16-1.png" width="60%"></p>
<p>The second is a <code>plot_cme</code> function to draw “Conditional Marginal Effects.” This is useful when a model includes interaction terms and we want to plot how the marginal effect of a variable changes as the value of a “condition” (or “moderator”) variable changes:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">hp</span> <span class="op">*</span> <span class="va">wt</span> <span class="op">+</span> <span class="va">drat</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span>

<span class="fu"><a href="reference/plot_cme.html">plot_cme</a></span><span class="op">(</span><span class="va">mod</span>, effect <span class="op">=</span> <span class="st">"hp"</span>, condition <span class="op">=</span> <span class="st">"wt"</span><span class="op">)</span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-17-1.png" width="60%"></p>
</div>
<div id="simple-analytic-example-quadratic-term" class="section level2">
<h2 class="hasAnchor">
<a href="#simple-analytic-example-quadratic-term" class="anchor"></a>Simple analytic example: Quadratic term</h2>
<p>Say you estimate a linear regression model with a quadratic term:</p>
<p><br><span class="math display"><em>Y</em> = <em>β</em><sub>0</sub> + <em>β</em><sub>1</sub><em>X</em><sup>2</sup> + <em>ε</em></span><br></p>
<p>and obtain estimates of <span class="math inline"><em>β</em><sub>0</sub> = 1</span> and <span class="math inline"><em>β</em><sub>1</sub> = 2</span>. Taking the partial derivative with respect to <span class="math inline"><em>X</em></span> and plugging in our estimates gives us the marginal effect of <span class="math inline"><em>X</em></span> on <span class="math inline"><em>Y</em></span>:</p>
<p><br><span class="math display">∂<em>Y</em>/∂<em>X</em> = <em>β</em><sub>0</sub> + 2 ⋅ <em>β</em><sub>1</sub><em>X</em> = 1 + 4<em>X</em></span><br></p>
<p>This result suggests that the effect of a <em>change</em> in <span class="math inline"><em>X</em></span> on <span class="math inline"><em>Y</em></span> depends on the <em>level</em> of <span class="math inline"><em>X</em></span>. When <span class="math inline"><em>X</em></span> is large and positive, an increase in <span class="math inline"><em>X</em></span> is associated to a large increase in <span class="math inline"><em>Y</em></span>. When <span class="math inline"><em>X</em></span> is small and positive, an increase in <span class="math inline"><em>X</em></span> is associated to a small increase in <span class="math inline"><em>Y</em></span>. When <span class="math inline"><em>X</em></span> is a large negative value, an increase in <span class="math inline"><em>X</em></span> is associated with a <em>decrease</em> in <span class="math inline"><em>Y</em></span>.</p>
<p><code>marginaleffects</code> arrives at the same conclusion in simultated data:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">1e5</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>
<span class="va">dat</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">*</span> <span class="va">dat</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">dat</span><span class="op">$</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, <span class="va">dat</span><span class="op">)</span>

<span class="fu"><a href="reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="fu"><a href="reference/typical.html">typical</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>truth <span class="op">=</span> <span class="fl">1</span> <span class="op">+</span> <span class="fl">4</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">dydx</span>, <span class="va">truth</span><span class="op">)</span>
<span class="co">#&gt;        dydx truth</span>
<span class="co">#&gt; 1 -6.983477    -7</span>
<span class="co">#&gt; 2 -2.990947    -3</span>
<span class="co">#&gt; 3  1.001582     1</span>
<span class="co">#&gt; 4  4.994111     5</span>
<span class="co">#&gt; 5  8.986640     9</span></code></pre></div>
<p>We can also plot the result with the <code>plot_cme</code> function:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/plot_cme.html">plot_cme</a></span><span class="op">(</span><span class="va">mod</span>, effect <span class="op">=</span> <span class="st">"x"</span>, condition <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-19-1.png" width="60%"></p>
</div>
<div id="benchmarks" class="section level2">
<h2 class="hasAnchor">
<a href="#benchmarks" class="anchor"></a>Benchmarks</h2>
<p>Here are two <em>very</em> naive benchmarks to compare the speed of <code>marginaleffects</code> and <code>margins</code>. Computing the unit-level marginal effects and standard errors in a logistic regression model with 2000 observations is over 400 times faster with <code>marginaleffects</code>. Calculating only the marginal effects is about 20% faster.</p>
<p>Simulate data and fit model:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">2000</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
    x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
    x3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
    x4 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
    e <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>
<span class="va">dat</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span><span class="op">(</span>
    <span class="va">dat</span><span class="op">$</span><span class="va">x1</span> <span class="op">+</span> <span class="va">dat</span><span class="op">$</span><span class="va">x2</span> <span class="op">+</span> <span class="va">dat</span><span class="op">$</span><span class="va">x3</span> <span class="op">+</span> <span class="va">dat</span><span class="op">$</span><span class="va">x4</span> <span class="op">+</span> <span class="va">dat</span><span class="op">$</span><span class="va">x3</span> <span class="op">*</span> <span class="va">dat</span><span class="op">$</span><span class="va">x4</span><span class="op">)</span><span class="op">)</span>

<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">x3</span> <span class="op">*</span> <span class="va">x4</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></code></pre></div>
<p>Marginal effects and standard errors:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>bench<span class="op">::</span><span class="kw">mark</span>(</span>
<span id="cb18-2"><a href="#cb18-2"></a>    margins<span class="op">::</span><span class="kw">margins</span>(mod, <span class="dt">unit_ses =</span> <span class="ot">TRUE</span>),</span>
<span id="cb18-3"><a href="#cb18-3"></a>    <span class="kw">marginaleffects</span>(mod),</span>
<span id="cb18-4"><a href="#cb18-4"></a>    <span class="dt">check =</span> <span class="ot">FALSE</span>)</span>
<span id="cb18-5"><a href="#cb18-5"></a></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="op">&gt;</span><span class="st"> </span>expression                                  min   median <span class="st">`</span><span class="dt">itr/sec</span><span class="st">`</span> mem_alloc</span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="op">&gt;</span><span class="st"> </span>margins<span class="op">::</span><span class="kw">margins</span>(mod, <span class="dt">unit_ses =</span> <span class="ot">TRUE</span>)    <span class="fl">1.08</span>m    <span class="fl">1.08</span>m    <span class="fl">0.0154</span>    <span class="fl">1.85</span>GB</span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">marginaleffects</span>(mod)                    <span class="fl">124.5</span>ms <span class="fl">154.43</span>ms    <span class="fl">5.75</span>     <span class="fl">51.63</span>MB</span></code></pre></div>
<p>Marginal effects only:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>bench<span class="op">::</span><span class="kw">mark</span>(</span>
<span id="cb19-2"><a href="#cb19-2"></a>    margins<span class="op">::</span><span class="kw">margins</span>(mod, <span class="dt">unit_ses =</span> <span class="ot">FALSE</span>),</span>
<span id="cb19-3"><a href="#cb19-3"></a>    <span class="kw">marginaleffects</span>(mod, <span class="dt">variance =</span> <span class="ot">FALSE</span>),</span>
<span id="cb19-4"><a href="#cb19-4"></a>    <span class="dt">check =</span> <span class="ot">FALSE</span>)</span>
<span id="cb19-5"><a href="#cb19-5"></a></span>
<span id="cb19-6"><a href="#cb19-6"></a>  expression                                   min   median <span class="st">`</span><span class="dt">itr/sec</span><span class="st">`</span> mem_alloc</span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="op">&gt;</span><span class="st"> </span>margins<span class="op">::</span><span class="kw">margins</span>(mod, <span class="dt">unit_ses =</span> <span class="ot">FALSE</span>)    131ms    146ms      <span class="fl">6.97</span>    <span class="fl">43.8</span>MB</span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="op">&gt;</span><span class="st"> </span><span class="kw">marginaleffects</span>(mod, <span class="dt">variance =</span> <span class="ot">FALSE</span>)     111ms    121ms      <span class="fl">8.32</span>    <span class="fl">32.7</span>MB</span></code></pre></div>
</div>
<div id="extending-marginaleffects-to-support-new-models" class="section level2">
<h2 class="hasAnchor">
<a href="#extending-marginaleffects-to-support-new-models" class="anchor"></a>Extending <code>marginaleffects</code> to support new models</h2>
<p>In most cases, extending <code>marginaleffects</code> to support new models is easy. Imagine you want to add support for an object called <code>model</code> of class <code>EXAMPLE</code> with N observations.</p>
<div id="step-1-check-if-marginaleffects-default-functions-work" class="section level4">
<h4 class="hasAnchor">
<a href="#step-1-check-if-marginaleffects-default-functions-work" class="anchor"></a><em>Step 1:</em> Check if <code>marginaleffects</code> default functions work:</h4>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># returns a named vector of coefficients</span>
<span class="fu"><a href="reference/get_coef.html">get_coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>

<span class="co"># returns a named vector of predictions </span>
<span class="co"># returns a named matrix of size NxK for models with K levels (e.g., multinomial logit)</span>
<span class="fu"><a href="reference/get_predict.html">get_predict</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>

<span class="co"># returns a named square matrix of size equal to the number of coefficients</span>
<span class="fu"><a href="reference/get_vcov.html">get_vcov</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>

<span class="co"># returns a new model object with different stored coefficients </span>
<span class="co"># calling get_predict(model) and get_predict(model_new) should produce different results</span>
<span class="va">model_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/set_coef.html">set_coef</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="reference/get_coef.html">get_coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">model_new</span><span class="op">)</span></code></pre></div>
<p>If all of these functions work out-of-the-box, there’s a good chance your model will be supported automatically. If they do <em>not</em> work, move to…</p>
</div>
<div id="step-2-define-the-missing-methods" class="section level4">
<h4 class="hasAnchor">
<a href="#step-2-define-the-missing-methods" class="anchor"></a><em>Step 2:</em> Define the missing methods.</h4>
<p>Find the class name of your model by calling:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></code></pre></div>
<p>Then, create functions (methods) called <code>get_coef.EXAMPLE</code>, <code>get_predict.EXAMPLE</code>, <code>vcov.EXAMPLE</code>, and <code>set_coef.EXAMPLE</code>, with the “EXAMPLE” replaced by the name your model class.</p>
</div>
<div id="step-3-add-tests" class="section level4">
<h4 class="hasAnchor">
<a href="#step-3-add-tests" class="anchor"></a><em>Step 3:</em> Add tests</h4>
<p>Create a file called <code>tests/testthat/test-PKGNAME.R</code> and write a few tests. Ideally, we would like to compare the results obtained by <code>marginaleffects</code> to an external source, like the <code>margins</code> package for <code>R</code>, or the <code>margins</code> command for <code>Stata</code>.</p>
</div>
<div id="step-4-finalize" class="section level4">
<h4 class="hasAnchor">
<a href="#step-4-finalize" class="anchor"></a><em>Step 4:</em> Finalize</h4>
<p>Add your new model class to the lists of supported models in:</p>
<ul>
<li>The <code>sanity_model</code> function of the <code>R/sanity.R</code> file.</li>
<li>The supported models CSV table in <code>data-raw/supported_models.csv</code>. Then, run the <code>data-raw/supported_models.R</code> script to propagate your change throughout the package documentation.</li>
<li>The “Suggests” list in the <code>DESCRIPTION</code> file.</li>
</ul>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/vincentarelbundock/marginaleffects/">https://​github.com/​vincentarelbundock/​marginaleffects/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/vincentarelbundock/marginaleffects/issues">https://​github.com/​vincentarelbundock/​marginaleffects/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>GPL (&gt;= 3)</small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Vincent Arel-Bundock <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0003-2042-7063" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://www.tidyverse.org/lifecycle/#experimental"><img src="https://img.shields.io/badge/lifecycle-experimental-orange.svg" alt="Lifecycle: experimental"></a></li>
<li><a href="https://github.com/vincentarelbundock/fastmargins/actions"><img src="https://github.com/vincentarelbundock/fastmargins/workflows/R-CMD-check/badge.svg" alt="R-CMD-check"></a></li>
<li><a href="https://codecov.io/gh/vincentarelbundock/marginaleffects?branch=main"><img src="https://codecov.io/gh/vincentarelbundock/marginaleffects/branch/main/graph/badge.svg" alt="Codecov test coverage"></a></li>
<li><a href="https://github.com/vincentarelbundock/marginaleffects/actions"><img src="https://github.com/vincentarelbundock/marginaleffects/workflows/R-CMD-check/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Vincent Arel-Bundock.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
