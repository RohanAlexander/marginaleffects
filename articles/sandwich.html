<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="marginaleffects">
<title>Standard Errors and Confidence Intervals • marginaleffects</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Standard Errors and Confidence Intervals">
<meta property="og:description" content="marginaleffects">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-default navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">marginaleffects</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.1.9106</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="https://vincentarelbundock.github.io/marginaleffects/articles/predictions.html">Predictions</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://vincentarelbundock.github.io/marginaleffects/articles/slopes.html">Slopes</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://vincentarelbundock.github.io/marginaleffects/articles/contrasts.html">Comparisons</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://vincentarelbundock.github.io/marginaleffects/articles/marginalmeans.html">Marginal means</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://vincentarelbundock.github.io/marginaleffects/articles/hypothesis.html">Hypothesis tests</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Functions</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/vincentarelbundock/marginaleffects/">
    <span class="fab fa fab fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="sandwich_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Standard Errors and Confidence Intervals</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/vincentarelbundock/marginaleffects/blob/HEAD/vignettes/sandwich.Rmd" class="external-link"><code>vignettes/sandwich.Rmd</code></a></small>
      <div class="d-none name"><code>sandwich.Rmd</code></div>
    </div>

    
    
<p>Some code in this vignette requires <code>marginaleffects</code> version 0.7.1 or <a href="https://vincentarelbundock.github.io/marginaleffects/#installation">the development version hosted on Github.</a></p>
<div class="section level2">
<h2 id="delta-method">Delta Method<a class="anchor" aria-label="anchor" href="#delta-method"></a>
</h2>
<p>All the standard errors generated by the <code><a href="../reference/slopes.html">slopes()</a></code>, <code><a href="../reference/comparisons.html">comparisons()</a></code>, and <code><a href="../reference/hypotheses.html">hypotheses()</a></code> functions of this package package are estimated using the delta method. Mathematical treatments of this method can be found in most statistics textbooks <a href="https://en.wikipedia.org/wiki/Delta_method" class="external-link">and on Wikipedia.</a> Roughly speaking, the delta method allows us to approximate the distribution of a smooth function of an asymptotically normal estimator.</p>
<p>Concretely, this allows us to generate standard errors around functions of a model’s coefficient estimates. Predictions, contrasts, marginal effects, and marginal means are functions of the coefficients, so we can use the delta method to estimate standard errors around all of those quantities. Since there are a lot of mathematical treatments available elsewhere, this vignette focuses on the “implementation” in <code>marginaleffects</code>.</p>
<p>Consider the case of the <code><a href="../reference/marginalmeans.html">marginalmeans()</a></code> function. When a user calls this function, they obtain a vector of marginal means. To estimate standard errors around this vector:</p>
<ol style="list-style-type: decimal">
<li>Take the numerical derivative of the marginal means vector with respect to the first coefficient in the model:
<ul>
<li>Compute marginal means with the original model: <span class="math inline">\(f(\beta)\)</span>
</li>
<li>Increment the first (and only the first) coefficient held inside the model object by a small amount, and compute marginal means again: <span class="math inline">\(f(\beta+\varepsilon)\)</span>
</li>
<li>Calculate: <span class="math inline">\(\frac{f(\beta+\varepsilon) - f(\beta)}{\varepsilon}\)</span>
</li>
</ul>
</li>
<li>Repeat step 1 for every coefficient in the model to construct a <span class="math inline">\(J\)</span> matrix.</li>
<li>Extract the variance-covariance matrix of the coefficient estimates: <span class="math inline">\(V\)</span>
</li>
<li>Standard errors are the square root of the diagonal of <span class="math inline">\(JVJ'\)</span>
</li>
</ol>
<p>The main function used to compute standard errors in <code>marginaleffects</code> is here: <a href="https://github.com/vincentarelbundock/marginaleffects/blob/main/R/get_se_delta.R" class="external-link uri">https://github.com/vincentarelbundock/marginaleffects/blob/main/R/get_se_delta.R</a></p>
</div>
<div class="section level2">
<h2 id="standard-errors-and-intervals-for-slopes-and-comparisons">Standard errors and intervals for <code>slopes()</code> and <code>comparisons()</code><a class="anchor" aria-label="anchor" href="#standard-errors-and-intervals-for-slopes-and-comparisons"></a>
</h2>
<p>All standard errors for the <code><a href="../reference/slopes.html">slopes()</a></code> and <code><a href="../reference/comparisons.html">comparisons()</a></code> functions are computed using the delta method, as described above.</p>
</div>
<div class="section level2">
<h2 id="standard-errors-and-intervals-for-marginalmeans">Standard errors and intervals for <code>marginalmeans()</code><a class="anchor" aria-label="anchor" href="#standard-errors-and-intervals-for-marginalmeans"></a>
</h2>
<p>The <code><a href="../reference/marginalmeans.html">marginalmeans()</a></code> function can compute the confidence intervals in two ways. If the following conditions hold:</p>
<ul>
<li>The user set: <code>type = "response"</code>
</li>
<li>The “link” type is supported for this model class</li>
<li>The <code>transform_post</code> argument is <code>NULL</code>
</li>
</ul>
<p>then <code><a href="../reference/marginalmeans.html">marginalmeans()</a></code> will first compute the marginal means on the link scale, and then back transform them using the inverse link function supplied by <code>insight::link_inverse(model)</code> function.</p>
<p>In all other cases, standard errors are computed using the delta method as described above.</p>
</div>
<div class="section level2">
<h2 id="standard-errors-and-intervals-for-predictions">Standard errors and intervals for <code>predictions()</code><a class="anchor" aria-label="anchor" href="#standard-errors-and-intervals-for-predictions"></a>
</h2>
<p>The <code>marginaleffects</code> package handles all calculations to compute standard errors, t statistics, p values, and confidence intervals for contrasts (<code><a href="../reference/comparisons.html">comparisons()</a></code>), marginal effects (<code><a href="../reference/slopes.html">slopes()</a></code>), and marginal means (<code><a href="../reference/marginalmeans.html">marginalmeans()</a></code>) functions.</p>
<p>When possible, however, the calculation of standard errors and confidence intervals for the output of <code><a href="../reference/predictions.html">predictions()</a></code> is outsourced to the <a href="https://easystats.github.io/insight/" class="external-link"><code>insight</code> package.</a> The benefit of this is that, for many popular models, <code>insight</code> can compute confidence intervals via back-transformation, which gives them certain nice properties. For example, this ensures that confidence intervals around the predictions of a logistic regression model will remain in between 0 and 1.</p>
<p>When <code>insight</code> does not support a model, <code>marginaleffects</code> computes standard errors using the delta method, as described above. In those cases, confidence intervals are not created automatically, but users can easily compute them manually, as usual, by multiplying the standard error by a critical value. The standard errors thus estimated <a href="https://en.wikipedia.org/wiki/Delta_method" class="external-link">have desirable properties under normal assumptions</a>, but since there is no back-transformation, it is not always advisable to use them to construct symmetric confidence intervals around adjusted predictions.</p>
<p>One special case is when we use the the <code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy()</a></code> or <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> functions to compute average predictions, or the <code>by</code> argument to compute average predictions by group. In those cases, it may be a good idea to compute predicted values on the link scale, average the predictions, and only <em>then</em> back transform. This can be done using the <code>transform_post</code> and <code>transform_avg</code> arguments. In this example, we use the <code>link_inverse</code> argument from the <code>insight</code> package to get the inverse link function:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://easystats.github.io/insight/" class="external-link">insight</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1024</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">25</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">.9</span><span class="op">)</span>,</span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>    groupid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># estimate model</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">groupid</span>, family <span class="op">=</span> <span class="va">binomial</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># average group-wise predictions</span></span>
<span><span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">mod</span>, by <span class="op">=</span> <span class="st">"groupid"</span><span class="op">)</span></span>
<span><span class="co">#&gt;       type groupid predicted  std.error statistic      p.value  conf.low conf.high</span></span>
<span><span class="co">#&gt; 1 response       1 0.8888889 0.10282561  8.644626 5.398200e-18 0.6873544  1.090423</span></span>
<span><span class="co">#&gt; 2 response       0 0.8750000 0.07697122 11.367885 6.043421e-30 0.7241392  1.025861</span></span></code></pre></div>
<p>Note that if we simply add 1.96*SE to the predictions, the upper bound of the confidence interval will exceed the logical limit of 1. Instead, one possibility would be to estimate the predicted values on the link scale, and then transform the results:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span></span>
<span>    <span class="va">mod</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"groupid"</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"link"</span>,</span>
<span>    transform_post <span class="op">=</span> <span class="fu"><a href="https://easystats.github.io/insight/reference/link_inverse.html" class="external-link">link_inverse</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   type groupid predicted    p.value  conf.low conf.high</span></span>
<span><span class="co">#&gt; 1 link       1 0.9135928 0.03809366 0.5323305 0.9899205</span></span>
<span><span class="co">#&gt; 2 link       0 0.9229036 0.02478264 0.5780974 0.9905287</span></span></code></pre></div>
<p>We can do something similar with average predictions using the <code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy()</a></code> or <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> functions:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span></span>
<span>    <span class="va">mod</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"link"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">p</span>, transform_avg <span class="op">=</span> <span class="fu"><a href="https://easystats.github.io/insight/reference/link_inverse.html" class="external-link">link_inverse</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Effect Std. Error     z  Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt; 1  2.438     0.8895 2.741 0.0061301 0.6945  4.181</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model type:  glm </span></span>
<span><span class="co">#&gt; Prediction type:  link</span></span></code></pre></div>
<p>Warning: users should be aware that these alternative approaches will not in general yield the same results, because the mean of a transformation is not always equal to the transformation of the mean:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://easystats.github.io/insight/reference/link_inverse.html" class="external-link">link_inverse</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.4706487</span></span>
<span><span class="fu"><a href="https://easystats.github.io/insight/reference/link_inverse.html" class="external-link">link_inverse</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.4665151</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="bootstrap">Bootstrap<a class="anchor" aria-label="anchor" href="#bootstrap"></a>
</h2>
<p>It is easy to use the bootstrap as an alternative strategy to compute standard errors and confidence intervals. Several <code>R</code> packages can help us achieve this, including the long-established <code>boot</code> package:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">boot</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bootfun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">indices</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span></span>
<span>    <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">am</span> <span class="op">+</span> <span class="va">hp</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">d</span><span class="op">)</span></span>
<span>    <span class="va">cmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">d</span>, vcov <span class="op">=</span> <span class="cn">FALSE</span>, variables <span class="op">=</span> <span class="st">"am"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">cmp</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mtcars</span>, statistic <span class="op">=</span> <span class="va">bootfun</span>, R <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ORDINARY NONPARAMETRIC BOOTSTRAP</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; boot(data = mtcars, statistic = bootfun, R = 1000)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Bootstrap Statistics :</span></span>
<span><span class="co">#&gt;     original     bias    std. error</span></span>
<span><span class="co">#&gt; t1* 4.157856 0.01543426    1.003461</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci</a></span><span class="op">(</span><span class="va">b</span>, type <span class="op">=</span> <span class="st">"perc"</span><span class="op">)</span></span>
<span><span class="co">#&gt; BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS</span></span>
<span><span class="co">#&gt; Based on 1000 bootstrap replicates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; CALL : </span></span>
<span><span class="co">#&gt; boot.ci(boot.out = b, type = "perc")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Intervals : </span></span>
<span><span class="co">#&gt; Level     Percentile     </span></span>
<span><span class="co">#&gt; 95%   ( 2.240,  6.277 )  </span></span>
<span><span class="co">#&gt; Calculations and Intervals on Original Scale</span></span></code></pre></div>
<p>Note that, in the code above, we set <code>vcov=FALSE</code> to avoid computation of delta method standard errors and speed things up.</p>
<p>Compare to the delta method standard errors:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">am</span> <span class="op">+</span> <span class="va">hp</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"am"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Term          Contrast Effect Std. Error     z   Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">#&gt; 1   am mean(1) - mean(0)  4.158      1.257 3.309 0.00093648 1.695  6.621</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model type:  lm </span></span>
<span><span class="co">#&gt; Prediction type:  response</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="robust-standard-errors">Robust standard errors<a class="anchor" aria-label="anchor" href="#robust-standard-errors"></a>
</h2>
<p>All the functions in the <code>marginaleffects</code> package can compute robust standard errors on the fly for any model type supported by <a href="https://sandwich.r-forge.r-project.org/" class="external-link">the <code>sandwich</code> package.</a> The <code>vcov</code> argument supports string shortcuts like <code>"HC3"</code>, a one-sided formula to request clustered standard errors, variance-covariance matrices, or functions which return such matrices. Here are a few examples.</p>
<p>Adjusted predictions with classical or heteroskedasticity-robust standard errors:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">hp</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">p</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;   rowid     type predicted std.error statistic       p.value conf.low conf.high mpg cyl disp  hp drat    wt  qsec vs am gear carb</span></span>
<span><span class="co">#&gt; 1     1 response  22.59375 0.7772744  29.06792 9.135725e-186 21.00634  24.18116  21   6  160 110  3.9 2.620 16.46  0  1    4    4</span></span>
<span><span class="co">#&gt; 2     2 response  22.59375 0.7772744  29.06792 9.135725e-186 21.00634  24.18116  21   6  160 110  3.9 2.875 17.02  0  1    4    4</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">mod</span>, vcov <span class="op">=</span> <span class="st">"HC3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">p</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;   rowid     type predicted std.error statistic       p.value conf.low conf.high mpg cyl disp  hp drat    wt  qsec vs am gear carb</span></span>
<span><span class="co">#&gt; 1     1 response  22.59375 0.8629746  26.18125 4.345995e-151 20.83132  24.35618  21   6  160 110  3.9 2.620 16.46  0  1    4    4</span></span>
<span><span class="co">#&gt; 2     2 response  22.59375 0.8629746  26.18125 4.345995e-151 20.83132  24.35618  21   6  160 110  3.9 2.875 17.02  0  1    4    4</span></span></code></pre></div>
<p>Marginal effects with cluster-robust standard errors:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mfx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/slopes.html">slopes</a></span><span class="op">(</span><span class="va">mod</span>, vcov <span class="op">=</span> <span class="op">~</span><span class="va">cyl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Term    Contrast   Effect Std. Error      z   Pr(&gt;|z|)   2.5 %   97.5 %</span></span>
<span><span class="co">#&gt; 1   hp mean(dY/dX) -0.06823    0.01868 -3.653 0.00025909 -0.1048 -0.03162</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model type:  lm </span></span>
<span><span class="co">#&gt; Prediction type:  response</span></span></code></pre></div>
<p>Comparing adjusted predictions with classical and robust standard errors:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_cap.html">plot_cap</a></span><span class="op">(</span><span class="va">mod</span>, condition <span class="op">=</span> <span class="st">"hp"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_cap.html">plot_cap</a></span><span class="op">(</span><span class="va">mod</span>, condition <span class="op">=</span> <span class="st">"hp"</span>, vcov <span class="op">=</span> <span class="st">"HC3"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span></span></code></pre></div>
<p><img src="sandwich_files/figure-html/unnamed-chunk-10-1.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="mixed-effects-models-satterthwaite-and-kenward-roger-corrections">Mixed effects models: Satterthwaite and Kenward-Roger corrections<a class="anchor" aria-label="anchor" href="#mixed-effects-models-satterthwaite-and-kenward-roger-corrections"></a>
</h2>
<p>For linear mixed effects models we can apply the Satterthwaite and Kenward-Roger corrections in the same way as above:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">mtcars</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">cyl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">am</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">am</span><span class="op">)</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">hp</span> <span class="op">+</span> <span class="va">am</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">cyl</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span></code></pre></div>
<p>Marginal effects at the mean with classical standard errors and z-statistic:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/slopes.html">slopes</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   rowid     type term     contrast        dydx  std.error statistic      p.value    conf.low   conf.high predicted predicted_hi predicted_lo      mpg       hp    am cyl    eps</span></span>
<span><span class="co">#&gt; 1     1 response   hp        dY/dX -0.05184187 0.01146238 -4.522784 6.103158e-06 -0.07430773 -0.02937602   17.7327     17.73123      17.7327 20.09062 146.6875 FALSE   8 0.0283</span></span>
<span><span class="co">#&gt; 2     1 response   am TRUE - FALSE  4.66614142 1.13425639  4.113833 3.891429e-05  2.44303975  6.88924310   17.7327     22.39884      17.7327 20.09062 146.6875 FALSE   8     NA</span></span></code></pre></div>
<p>Marginal effects at the mean with Kenward-Roger adjusted variance-covariance and degrees of freedom:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/slopes.html">slopes</a></span><span class="op">(</span><span class="va">mod</span>,</span>
<span>                newdata <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>                vcov <span class="op">=</span> <span class="st">"kenward-roger"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   rowid     type term     contrast        dydx  std.error statistic    p.value   conf.low   conf.high       df predicted predicted_hi predicted_lo      mpg       hp    am cyl    eps</span></span>
<span><span class="co">#&gt; 1     1 response   hp        dY/dX -0.05184187 0.01518879 -3.413167 0.09642979 -0.1305545  0.02687074 1.682575   17.7327     17.73123      17.7327 20.09062 146.6875 FALSE   8 0.0283</span></span>
<span><span class="co">#&gt; 2     1 response   am TRUE - FALSE  4.66614142 1.28244270  3.638479 0.08741990 -1.9798401 11.31212296 1.682575   17.7327     22.39884      17.7327 20.09062 146.6875 FALSE   8     NA</span></span></code></pre></div>
<p>We can use the same option in any of the package’s core functions, including:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_cap.html">plot_cap</a></span><span class="op">(</span><span class="va">mod</span>, condition <span class="op">=</span> <span class="st">"hp"</span>, vcov <span class="op">=</span> <span class="st">"satterthwaite"</span><span class="op">)</span></span></code></pre></div>
<p><img src="sandwich_files/figure-html/unnamed-chunk-14-1.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="bayesian-estimates-and-credible-intervals">Bayesian estimates and credible intervals<a class="anchor" aria-label="anchor" href="#bayesian-estimates-and-credible-intervals"></a>
</h2>
<p><a href="https://vincentarelbundock.github.io/marginaleffects/reference/brms.html">See the <code>brms</code> vignette</a> for a discussion of bayesian estimates and credible intervals.</p>
</div>
<div class="section level2">
<h2 id="uncertainty-around-unit-level-or-average-estimates">Uncertainty around unit-level or average estimates<a class="anchor" aria-label="anchor" href="#uncertainty-around-unit-level-or-average-estimates"></a>
</h2>
<p>Note that it is normal to observe that confidence intervals around average estimates tend to be tighter than those around unit-level estimates:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">hp</span> <span class="op">*</span> <span class="va">qsec</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># On average CIs around unit-level estimates are:</span></span>
<span><span class="va">pre1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">pre1</span><span class="op">$</span><span class="va">conf.high</span> <span class="op">-</span> <span class="va">pre1</span><span class="op">$</span><span class="va">conf.low</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4.00873</span></span>
<span></span>
<span><span class="co"># The CI of the average estimate is:</span></span>
<span><span class="va">pre2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">pre2</span><span class="op">$</span><span class="va">conf.high</span> <span class="op">-</span> <span class="va">pre2</span><span class="op">$</span><span class="va">conf.low</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2.035368</span></span>
<span></span>
<span><span class="co"># On average CIs around unit-level estimates are:</span></span>
<span><span class="va">cmp1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"hp"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cmp1</span><span class="op">$</span><span class="va">conf.high</span> <span class="op">-</span> <span class="va">cmp1</span><span class="op">$</span><span class="va">conf.low</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.05572727</span></span>
<span></span>
<span><span class="co"># The CI of the average estimate is:</span></span>
<span><span class="va">cmp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"hp"</span>, transform_pre <span class="op">=</span> <span class="st">"differenceavg"</span><span class="op">)</span></span>
<span><span class="va">cmp2</span><span class="op">$</span><span class="va">conf.high</span> <span class="op">-</span> <span class="va">cmp2</span><span class="op">$</span><span class="va">conf.low</span></span>
<span><span class="co">#&gt; [1] 0.0492053</span></span></code></pre></div>
<!--
Relevant?
https://en.wikipedia.org/wiki/Jensen%27s_inequality
https://math.stackexchange.com/questions/34009/is-the-variance-of-a-convex-function-a-convex-function/34021#34021?newreg=698ab30a481945878307935ac5d6b629
-->
<!--
NO LONGER RELEVANT WITH THE AVERAGE() + RECALL() REFACTOR SINCE WE COMPUTE SEs DIRECTLY ON THE MARGINS W

## Standard Error of the Average Marginal Effect or Contrast

The `summary()` and `tidy()` functions compute the average marginal effect (or contrast) when they are applied to an object produced by `slopes()` (or `comparisons()`). This is done in 3 steps:

1. Extract the Jacobian used to compute unit-level standard errors.
2. Take the average of that Jacobian.
3. Estimate the standard error of the average marginal effect as the square root of the diagonal of J'VJ, where V is the variance-covariance matrix.

As [explained succinctly on Stack Exchange:](https://stats.stackexchange.com/a/331311/4874)

> we want the variance of the Average Marginal Effect (AME) and hence our transformed function is: $AME =  \frac{1}{N} \sum_{i=1}^N g_i(x_i,\hat{\beta})$ Then using the delta method we have $Var \left( g(\hat{\beta}) \right) = J_g' \Omega_{\hat{\beta}} J_g$ where $\Omega_{\hat{\beta}} = Var(\hat{\beta})$ and $J_g' = \frac{\partial\left[\frac{1}{N}\sum_{i=1}^N g (x_i,\hat{\beta})\right]}{\partial \hat\beta} = \frac{1}{N}{\left[\sum_{i=1}^N \frac{\partial \left (g (x_i,\hat{\beta})\right)}{\partial \hat\beta}\right]}$ Which justifies using the "average Jacobian" in the delta method to calculate variance of the AME.

References:

* Dowd, Bryan E, William H Greene, and Edward C Norton. “Computation of Standard Errors.” Health Services Research 49, no. 2 (April 2014): 731–50. https://doi.org/10.1111/1475-6773.12122.
* https://stats.stackexchange.com/questions/283831/delta-method-for-marginal-effects-of-generalized-linear-model?rq=1
-->
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Vincent Arel-Bundock.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
